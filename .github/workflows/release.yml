name: Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install build twine
    
    - name: Build package
      run: |
        echo "Building Python package..."
        python -m build
        
        echo "Package contents:"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  test-package:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
    
    - name: Test package installation
      run: |
        echo "Testing package installation..."
        pip install dist/*.whl
        python -c "import pi_pages; print('âœ… Package installed successfully')"
    
    - name: Test package functionality
      run: |
        echo "Testing package functionality..."
        python -c "
        import pi_pages
        print('âœ… Package import successful')
        
        # Test basic functionality
        try:
            config = pi_pages.PiPages()
            print('âœ… PiPages class instantiated successfully')
        except Exception as e:
            print(f'âš ï¸ PiPages instantiation failed: {e}')
        "

  publish:
    needs: [build, test-package]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: dist/
    
    - name: Create Release Summary
      uses: actions/github-script@v6
      with:
        script: |
          const release = context.payload.release;
          const comment = `## ðŸŽ‰ Release ${release.tag_name} Published!
          
          **Release Notes**: ${release.body || 'No release notes provided'}
          
          **Package**: Available on PyPI as \`pip install pi-pages\`
          
          **GitHub Release**: ${release.html_url}
          
          **Build Status**: âœ… All checks passed
          
          ---
          *This release was automatically published via GitHub Actions*`;
          
          // Comment on the release
          github.rest.repos.createReleaseComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.id,
            body: comment
          });
    
    - name: Success summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Package Build**: Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Package Testing**: Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **PyPI Publishing**: Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Release Comment**: Added" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Release ${GITHUB_REF#refs/tags/} published successfully!**" >> $GITHUB_STEP_SUMMARY 